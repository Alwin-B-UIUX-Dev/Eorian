@startuml 02-jwt-security-system

left to right direction

skinparam class {
    StereotypeFontColor #ffffff
}

title 02 JWT Security System - Current Implementation

package "Interfaces" {
  package "Base" {
    interface IAdditionalInfo {
      +readonly [key: string]: unknown
    }
  }

  package "Security" {
    interface ITokenManager {
      +generateAccessToken(payload: ITokenPayload): Promise<string>
      +generateRefreshToken(payload: ITokenPayload): Promise<string>
      +verifyToken(token: string): Promise<ITokenPayload>
    }

    interface ITokenPayload {
      +[key: string]: unknown
      +userId: string
      +username?: string
      +role: string
    }

    interface IBlacklistService {
      +addToken(jti: string): Promise<void>
      +isTokenBlacklisted(jti: string): Promise<boolean>
    }
  }
}

package "Exceptions" {
  package "Base" {
    class ApiError {
      +message: string
      +statusCode: number
      +additionalInfo: IAdditionalInfo
      +timestamp: Date

      +constructor(message: string, statusCode: number, additionalInfo: IAdditionalInfo)
      +log(): this
    }
  }

  package "Security" {
    class TokenError << (F,#000000) Factory >> {
      +constructor(message: string, statusCode: number, additionalInfo: IAdditionalInfo)
      +{static} invalidFormat(): TokenError
      +{static} invalidPayload(): TokenError
      +{static} generation(originalError?: string): TokenError
      +{static} verification(originalError?: string): TokenError
      +{static} expired(): TokenError
      +{static} invalid(): TokenError
      +{static} notActive(): TokenError
      +{static} invalidSecret(): TokenError
    }
  }
}

package "Security Implementations" {
  class TokenManager {
    -readonly secret: Uint8Array
    -readonly accessTokenExpiresIn: string
    -readonly refreshTokenExpiresIn: string
    -readonly issuer: string
    -readonly audience: string

    +constructor(secret?: string)
    +generateAccessToken(payload: ITokenPayload): Promise<string>
    +generateRefreshToken(payload: ITokenPayload): Promise<string>
    +verifyToken(token: string): Promise<ITokenPayload>
  }

  class BlacklistService << (S,#000000) Singleton >> {
    -{static} instance: BlacklistService
    -readonly blacklistedTokens: Set<string>

    -constructor()
    +{static} getInstance(): BlacklistService
    +addToken(jti: string): Promise<void>
    +isTokenBlacklisted(jti: string): Promise<boolean>
  }
}

package "External Libraries" {
  class SignJWT {
    +setProtectedHeader(header: object): SignJWT
    +setJti(jti: string): SignJWT
    +setIssuedAt(): SignJWT
    +setExpirationTime(exp: string): SignJWT
    +setIssuer(iss: string): SignJWT
    +setAudience(aud: string): SignJWT
    +sign(secret: Uint8Array): Promise<string>
  }

  class jwtVerify {
    +{static} verify(token: string, secret: Uint8Array, options: object): Promise<{payload: any}>
  }

  class crypto {
    +{static} randomUUID(): string
  }

  class Set {
    +add(value: string): Set<string>
    +has(value: string): boolean
    +size: number
  }
}

' HÉRITAGE (Rouge - épais)
ApiError <|-- TokenError #line:red;line.bold;text:red : extends

' IMPLÉMENTATION (Teal - pointillé)
ITokenManager <|.. TokenManager #line:teal;line.dashed;text:teal : implements
IBlacklistService <|.. BlacklistService #line:teal;line.dashed;text:teal : implements

' USAGE/DÉPENDANCE (Bleu cyan - pointillé)
ApiError ..> IAdditionalInfo #line:cyan;line.dotted;text:cyan : uses
TokenError ..> IAdditionalInfo #line:cyan;line.dotted;text:cyan : uses
ITokenManager ..> ITokenPayload #line:cyan;line.dotted;text:cyan : uses
TokenManager ..> ITokenPayload #line:cyan;line.dotted;text:cyan : uses

' EXTERNAL LIBRARY USAGE (Lime/Vert clair - pointillé)
TokenManager ..> SignJWT #line:lime;line.dotted;text:lime : uses
TokenManager ..> jwtVerify #line:lime;line.dotted;text:lime : uses
TokenManager ..> crypto #line:lime;line.dotted;text:lime : uses
BlacklistService ..> Set #line:lime;line.dotted;text:lime : uses

' THROW/EXCEPTIONS (Magenta - pointillé)
TokenManager ..> TokenError #line:magenta;line.dotted;text:magenta : throws

' SINGLETON PATTERN (Green - épais)
BlacklistService ..> BlacklistService #line:green;line.bold;text:green : singleton

note as couleurs
  **LÉGENDE DES COULEURS**
  Rouge (épais) : Héritage (extends)
  Teal (pointillé) : Implémentation (implements)
  Cyan (pointillé) : Usage/Dépendance
  Lime (pointillé) : Librairies externes
  Magenta (pointillé) : Exceptions thrown
  Green (épais) : Pattern Singleton
end note

note right of TokenManager
  **GESTION JWT AVEC JOSE**
  - JOSE library moderne (RFC 7519)
  - Async/await natif
  - Validation stricte issuer/audience
  - JTI unique avec crypto.randomUUID()
  - Secret en Uint8Array (sécurisé)
  - Expiration configurable (15m/7d)
  - Gestion erreurs typées jose
  - Protection contre timing attacks
end note

note right of BlacklistService
  **RÉVOCATION TOKENS**
  - Singleton pattern pour cohérence
  - Set<string> pour performance O(1)
  - Pas de doublons automatique
  - Stockage en mémoire (MVP)
  - Async interface (future DB/Redis)
  - Thread-safe avec Set
  - Évolutif vers persistence
end note

note left of TokenError
  **ERREURS JWT SPÉCIALISÉES**
  - Factory methods statiques
  - Gestion erreurs JOSE spécifiques
  - JWTExpired, JWTInvalid, JWTClaimValidationFailed
  - Préservation original error
  - Codes d'erreur standardisés
  - Audit trail intégré
  - Pas de leak informations sensibles
end note

note bottom of ITokenPayload
  **PAYLOAD JWT EXTENSIBLE**
  - [key: string]: unknown → Index signature
  - userId : identifiant unique utilisateur
  - username : nom d'utilisateur (optionnel)
  - role : rôle utilisateur (RBAC)
  - Extensible dynamiquement
  - Propriétés JOSE automatiques (jti, iat, exp)
  - Conformité RGPD
  - Flexibility pour évolution
end note

note top of SignJWT
  **JOSE LIBRARY BENEFITS**
  - RFC 7519 compliant
  - Modern async API
  - Method chaining pattern
  - Built-in validation
  - Performance optimized
  - Security focused
  - TypeScript native
end note

note top of Set
  **SET COLLECTION**
  - Unique values only
  - O(1) add/has operations
  - Memory efficient
  - No duplicates handling
  - Iterator support
  - Built-in JavaScript
end note

@enduml
